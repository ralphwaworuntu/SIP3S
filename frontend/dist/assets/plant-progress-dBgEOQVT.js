import{f as _,r as l,j as e,B as b}from"./index-CHgft2lY.js";import{u as J,t as z,o as G,n as y,s as M,e as S,Z as N}from"./zod-Gn9GJoif.js";import{u as C}from"./useQuery-MNioBGo0.js";import{u as Q}from"./useMutation-Clv9eckx.js";import{m as H}from"./ArrowsClockwise.es-HnGY3Lkl.js";import{u as U,a as O,n as W,s as Z}from"./use-camera-MX5YYxuW.js";import{s as X}from"./CaretDown.es-BcmPl2Vd.js";import{s as Y}from"./CheckCircle.es-C5ggmx87.js";import{p as ee}from"./MapPinLine.es-BnBamJ0U.js";import{m as ae}from"./WarningCircle.es-CFc85ZaX.js";import{A as w}from"./alert-CxxZB5vu.js";import{B as se}from"./badge-1jXCihSW.js";import{C as I,a as B,b as F,c as E,d as R}from"./card-D1DJHsi0.js";import{b as v}from"./bhabin-service-CDJ-XKa-.js";import"./mock-data-CaIK6OKu.js";const $=["Pembersihan Lahan","Mulai Penanaman","Penyiraman / Pengairan","Penyulaman","Penyiangan","Penggemburan Tanah","Pengendalian Hama dan Penyakit","Pemangkasan","Pemupukan"],te=G({recipientId:M().min(1,"Pilih petani"),fase:S($,{errorMap:()=>({message:"Pilih fase tanam"})}),kondisi:S(["baik","waspada","kritikal"]),catatan:M().min(5,"Jelaskan kondisinya"),pupukDigunakanKg:y({invalid_type_error:"Masukkan angka"}).min(0,"Minimal 0").optional(),luasLahanBersihM2:y({invalid_type_error:"Masukkan angka"}).min(0,"Minimal 0").optional(),bibitDitanamKg:y({invalid_type_error:"Masukkan angka"}).min(0,"Minimal 0").optional()}).superRefine((t,d)=>{t.fase==="Pemupukan"&&(t.pupukDigunakanKg===void 0||Number.isNaN(t.pupukDigunakanKg))&&d.addIssue({code:N.custom,path:["pupukDigunakanKg"],message:"Isi jumlah pupuk (Kg)"}),t.fase==="Pembersihan Lahan"&&(t.luasLahanBersihM2===void 0||Number.isNaN(t.luasLahanBersihM2))&&d.addIssue({code:N.custom,path:["luasLahanBersihM2"],message:"Isi luas lahan (m2)"}),t.fase==="Mulai Penanaman"&&(t.bibitDitanamKg===void 0||Number.isNaN(t.bibitDitanamKg))&&d.addIssue({code:N.custom,path:["bibitDitanamKg"],message:"Isi jumlah bibit (Kg)"})}),ne={baik:"success",waspada:"neutral",kritikal:"warning"},ie=t=>t?`${t.nama} â€¢ ${t.komoditas} â€¢ ${t.wilayah}`:"-- pilih petani --",T=t=>new Date(t).toLocaleString("id-ID",{dateStyle:"medium",timeStyle:"short"}),Ne=()=>{const t=_(),[d,m]=l.useState(null),[g,P]=l.useState(""),[p,h]=l.useState(!1),k=l.useRef(null),K=l.useRef(null),n=U(),o=O(),D=C({queryKey:["bhabin","recipients"],queryFn:()=>v.listRecipients()}),x=l.useMemo(()=>D.data??[],[D.data]),c=l.useMemo(()=>x.filter(a=>a.status!=="rejected"),[x]),L=l.useMemo(()=>{const a=g.trim().toLowerCase();return a?c.filter(r=>`${r.nama} ${r.nik} ${r.komoditas} ${r.wilayah}`.toLowerCase().includes(a)):c},[c,g]),s=J({resolver:z(te),defaultValues:{recipientId:"",fase:"Pembersihan Lahan",kondisi:"baik",catatan:"",pupukDigunakanKg:void 0,luasLahanBersihM2:void 0,bibitDitanamKg:void 0}}),f=s.watch("recipientId"),u=s.watch("fase"),i=l.useMemo(()=>x.find(a=>a.id===f)??null,[f,x]);l.useEffect(()=>{if(!p){P("");return}const a=r=>{k.current&&!k.current.contains(r.target)&&h(!1)};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[p]),l.useEffect(()=>{if(p){const a=window.setTimeout(()=>{var r;return(r=K.current)==null?void 0:r.focus()},0);return()=>window.clearTimeout(a)}},[p]),l.useEffect(()=>{u!=="Pemupukan"&&s.resetField("pupukDigunakanKg",{defaultValue:void 0}),u!=="Pembersihan Lahan"&&s.resetField("luasLahanBersihM2",{defaultValue:void 0}),u!=="Mulai Penanaman"&&s.resetField("bibitDitanamKg",{defaultValue:void 0})},[u,s]);const A=a=>{s.setValue("recipientId",a.id,{shouldValidate:!0,shouldDirty:!0}),s.clearErrors("recipientId"),h(!1)},q=C({queryKey:["bhabin","plant"],queryFn:()=>v.listPlantProgress()}),j=Q({mutationFn:a=>v.submitPlantProgress(a),onSuccess:()=>{t.invalidateQueries({queryKey:["bhabin","plant"]}),m({type:"success",message:"Perkembangan tanaman tersimpan."}),s.reset({recipientId:"",fase:"Pembersihan Lahan",kondisi:"baik",catatan:"",pupukDigunakanKg:void 0,luasLahanBersihM2:void 0,bibitDitanamKg:void 0}),o.restart()},onError:()=>m({type:"error",message:"Gagal menyimpan perkembangan tanaman."})}),V=a=>{if(!i){m({type:"error",message:"Pilih petani terlebih dahulu."}),h(!0);return}if(!n.latitude||!n.longitude){m({type:"error",message:"GPS belum siap. Tekan segarkan dan pastikan izin lokasi aktif."});return}if(!o.preview){m({type:"error",message:"Ambil foto kondisi tanaman terlebih dahulu."});return}m(null);const r={wilayah:i.wilayah,petani:i.nama,komoditas:i.komoditas,fase:a.fase,kondisi:a.kondisi,catatan:a.catatan,lokasi:{latitude:n.latitude,longitude:n.longitude,alamat:n.alamat},fotoEvidence:o.preview,pupukDigunakanKg:a.fase==="Pemupukan"?a.pupukDigunakanKg:void 0,luasLahanBersihM2:a.fase==="Pembersihan Lahan"?a.luasLahanBersihM2:void 0,bibitDitanamKg:a.fase==="Mulai Penanaman"?a.bibitDitanamKg:void 0,reporter:"bhabin"};j.mutate(r)};return e.jsxs("section",{className:"grid gap-4 xl:grid-cols-2",children:[e.jsxs(I,{className:"bg-white",children:[e.jsxs(B,{children:[e.jsx(F,{children:"Input perkembangan tanaman"}),e.jsx(E,{children:"Laporkan kondisi tanaman untuk koordinasi cepat dengan PPL."})]}),e.jsxs(R,{className:"space-y-3 text-sm text-slate-netral",children:[d&&e.jsx(w,{variant:d.type==="success"?"success":d.type==="error"?"error":"info",children:e.jsxs("div",{className:"flex items-center gap-2",children:[d.type==="success"?e.jsx(Y,{className:"h-5 w-5",weight:"bold"}):e.jsx(ae,{className:"h-5 w-5",weight:"bold"}),e.jsx("span",{children:d.message})]})}),e.jsxs("form",{className:"space-y-3",onSubmit:s.handleSubmit(V),children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("span",{children:"Pilih petani penerima"}),e.jsxs("div",{className:"relative",ref:k,children:[e.jsxs("button",{type:"button",className:"flex w-full items-center justify-between rounded-2xl border border-abu-kartu px-3 py-2 text-left text-sm text-teks-gelap hover:border-biru-pemerintah/60",onClick:()=>c.length>0&&h(a=>!a),disabled:c.length===0,children:[e.jsx("span",{className:i?"":"text-slate-netral",children:ie(i)}),e.jsx(X,{className:"ml-2 h-4 w-4 text-slate-netral",weight:"bold"})]}),p&&e.jsxs("div",{className:"absolute z-30 mt-2 w-full rounded-2xl border border-abu-kartu bg-white p-3 shadow-xl",children:[e.jsx("input",{ref:K,type:"search",className:"w-full rounded-2xl border border-abu-kartu px-3 py-2 text-sm",placeholder:"Cari nama, NIK, komoditas, atau wilayah",value:g,onChange:a=>P(a.target.value)}),e.jsx("div",{className:"mt-2 max-h-60 overflow-y-auto",children:L.length>0?L.map(a=>{const r=a.id===f;return e.jsxs("button",{type:"button",className:`flex w-full flex-col items-start rounded-xl px-3 py-2 text-left text-sm transition hover:bg-biru-pemerintah/10 ${r?"bg-biru-pemerintah/10 text-biru-pemerintah":"text-teks-gelap"}`,onClick:()=>A(a),children:[e.jsx("span",{className:"font-medium",children:a.nama}),e.jsxs("span",{className:"text-xs text-slate-netral",children:[a.nik," â€¢ ",a.komoditas," â€¢ ",a.wilayah]})]},a.id)}):e.jsx("p",{className:"px-2 py-4 text-center text-sm text-slate-netral",children:"Tidak ditemukan data sesuai pencarian."})})]})]}),c.length===0&&e.jsx("span",{className:"text-xs text-slate-netral",children:"Belum ada data penerima."}),s.formState.errors.recipientId&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:s.formState.errors.recipientId.message})]}),i&&e.jsxs("div",{className:"rounded-2xl border border-abu-kartu bg-white p-3 text-xs text-slate-netral",children:[e.jsx("p",{className:"text-sm font-semibold text-teks-gelap",children:i.nama}),e.jsxs("p",{children:["NIK: ",i.nik]}),e.jsxs("p",{children:["Kelompok: ",i.kelompok]}),e.jsxs("p",{children:["Komoditas: ",i.komoditas]}),e.jsxs("p",{children:["Wilayah: ",i.wilayah]}),e.jsxs("p",{children:["Jadwal distribusi: ",T(i.jadwalDistribusi)]})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:["Fase tanam",e.jsx("select",{className:"rounded-2xl border border-abu-kartu px-3 py-2",...s.register("fase"),children:$.map(a=>e.jsx("option",{value:a,children:a},a))})]}),u==="Pemupukan"&&e.jsxs("label",{className:"flex flex-col gap-1",children:["Jumlah pupuk yang digunakan (Kg)",e.jsx("input",{type:"number",step:"0.1",className:"rounded-2xl border border-abu-kartu px-3 py-2",placeholder:"Contoh: 50",...s.register("pupukDigunakanKg",{valueAsNumber:!0})}),s.formState.errors.pupukDigunakanKg&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:s.formState.errors.pupukDigunakanKg.message})]}),u==="Pembersihan Lahan"&&e.jsxs("label",{className:"flex flex-col gap-1",children:["Jumlah luas lahan yang dibersihkan (m2)",e.jsx("input",{type:"number",step:"0.1",className:"rounded-2xl border border-abu-kartu px-3 py-2",placeholder:"Contoh: 500",...s.register("luasLahanBersihM2",{valueAsNumber:!0})}),s.formState.errors.luasLahanBersihM2&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:s.formState.errors.luasLahanBersihM2.message})]}),u==="Mulai Penanaman"&&e.jsxs("label",{className:"flex flex-col gap-1",children:["Jumlah bibit yang ditanam (Kg)",e.jsx("input",{type:"number",step:"0.1",className:"rounded-2xl border border-abu-kartu px-3 py-2",placeholder:"Contoh: 30",...s.register("bibitDitanamKg",{valueAsNumber:!0})}),s.formState.errors.bibitDitanamKg&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:s.formState.errors.bibitDitanamKg.message})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:["Kondisi",e.jsxs("select",{className:"rounded-2xl border border-abu-kartu px-3 py-2",...s.register("kondisi"),children:[e.jsx("option",{value:"baik",children:"Baik"}),e.jsx("option",{value:"waspada",children:"Perlu perhatian"}),e.jsx("option",{value:"kritikal",children:"Butuh tindak lanjut"})]})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:["Catatan lapangan",e.jsx("textarea",{className:"rounded-2xl border border-abu-kartu px-3 py-2",rows:3,...s.register("catatan")}),s.formState.errors.catatan&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:s.formState.errors.catatan.message})]}),e.jsxs("div",{className:"space-y-2 rounded-2xl border border-abu-kartu p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-medium text-teks-gelap",children:"Koordinat lokasi"}),e.jsxs(b,{type:"button",variant:"outline",size:"sm",onClick:n.refresh,disabled:n.isLoading,className:"inline-flex items-center gap-1",children:[e.jsx(H,{className:`h-4 w-4 ${n.isLoading?"animate-spin":""}`,weight:"bold"}),e.jsx("span",{children:n.isLoading?"Memuat":"Segarkan"})]})]}),e.jsxs("div",{className:"flex items-start gap-2 text-xs text-slate-netral",children:[e.jsx(ee,{className:"mt-0.5 h-4 w-4",weight:"bold"}),e.jsxs("div",{children:[n.latitude&&n.longitude?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:n.alamat}),e.jsxs("p",{children:["Lat ",n.latitude.toFixed(4)," | Long ",n.longitude.toFixed(4)]})]}):n.isLoading?e.jsx("p",{children:"Mengambil lokasi terkini..."}):e.jsx("p",{children:"Lokasi belum tersedia. Pastikan izin GPS aktif lalu tekan segarkan."}),n.error&&e.jsx("p",{className:"text-oranye-hangat",children:n.error})]})]})]}),e.jsxs("div",{className:"space-y-3 rounded-2xl border border-abu-kartu p-3",children:[e.jsx("p",{className:"text-sm font-medium text-teks-gelap",children:"Dokumentasi kondisi tanaman"}),o.streamError&&e.jsx(w,{variant:"warning",children:o.streamError}),o.preview?e.jsxs("div",{className:"space-y-3",children:[e.jsx("img",{src:o.preview,alt:"Dokumentasi tanaman",className:"h-56 w-full rounded-2xl object-cover"}),e.jsxs(b,{type:"button",variant:"outline",onClick:o.restart,children:[e.jsx(Z,{className:"mr-2 h-5 w-5",weight:"bold"})," Ambil Ulang"]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("video",{ref:o.videoRef,autoPlay:!0,playsInline:!0,className:"h-56 w-full rounded-2xl bg-black/60 object-cover"}),e.jsx("canvas",{ref:o.canvasRef,className:"hidden"}),e.jsxs(b,{type:"button",className:"w-full",onClick:o.capturePhoto,children:[e.jsx(W,{className:"mr-2 h-5 w-5",weight:"bold"})," Ambil Foto"]})]})]}),e.jsx(b,{type:"submit",className:"w-full",disabled:j.isPending,children:j.isPending?"Menyimpan...":"Kirim laporan"}),e.jsx(w,{variant:"info",className:"text-xs",children:"Data disimpan otomatis meski offline dan akan tersinkron ketika koneksi kembali."})]})]})]}),e.jsxs(I,{className:"bg-white",children:[e.jsxs(B,{children:[e.jsx(F,{children:"Riwayat perkembangan"}),e.jsx(E,{children:"Data terbaru dari lapangan."})]}),e.jsx(R,{className:"space-y-2 text-xs text-slate-netral",children:(q.data??[]).map(a=>e.jsxs("div",{className:"rounded-2xl border border-abu-kartu p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-teks-gelap",children:a.petani}),e.jsx(se,{variant:ne[a.kondisi],children:a.kondisi.toUpperCase()})]}),e.jsxs("p",{children:["Wilayah: ",a.wilayah]}),e.jsxs("p",{children:["Komoditas: ",a.komoditas]}),e.jsxs("p",{children:["Fase: ",a.fase]}),e.jsxs("p",{children:["Catatan: ",a.catatan]}),e.jsxs("p",{children:["Update: ",T(a.updatedAt)]}),a.lokasi&&e.jsxs("p",{children:["Lokasi: Lat ",a.lokasi.latitude.toFixed(4)," | Long ",a.lokasi.longitude.toFixed(4)]}),a.fotoEvidence&&e.jsx("img",{src:a.fotoEvidence,alt:`Dokumentasi ${a.petani}`,className:"mt-2 h-32 w-full rounded-2xl object-cover"})]},a.id))})]})]})};export{Ne as default};
//# sourceMappingURL=plant-progress-dBgEOQVT.js.map
