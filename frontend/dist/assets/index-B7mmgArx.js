import{r as e,p as K,e as N,v as $,u as q,h as Q,f as z,j as a,B as k}from"./index-CHgft2lY.js";import{u as S}from"./useQuery-MNioBGo0.js";import{u as J}from"./useMutation-Clv9eckx.js";import{s as W}from"./CheckCircle.es-C5ggmx87.js";import{s as _}from"./CloudArrowUp.es-CkJROIPM.js";import{l as Y}from"./DownloadSimple.es-CfPHfGgj.js";import{p as X}from"./MapPin.es-B4F3WwaZ.js";import{c as aa}from"./SignOut.es-CgT6o7lR.js";import{m as ea}from"./WarningCircle.es-CFc85ZaX.js";import{C,a as L,b as P,c as D,d as F}from"./card-D1DJHsi0.js";import{B as b}from"./badge-1jXCihSW.js";import{A as ta}from"./alert-CxxZB5vu.js";import{f as sa,k as w}from"./mock-data-CaIK6OKu.js";const la=new Map([["bold",e.createElement(e.Fragment,null,e.createElement("path",{d:"M216.49,79.52l-56-56A12,12,0,0,0,152,20H56A20,20,0,0,0,36,40V216a20,20,0,0,0,20,20H200a20,20,0,0,0,20-20V88A12,12,0,0,0,216.49,79.52ZM183,80H160V57ZM60,212V44h76V92a12,12,0,0,0,12,12h48V212Zm100.49-72.49a12,12,0,0,1-17,17L140,153v31a12,12,0,0,1-24,0V153l-3.51,3.52a12,12,0,0,1-17-17l24-24a12,12,0,0,1,17,0Z"}))],["duotone",e.createElement(e.Fragment,null,e.createElement("path",{d:"M208,88H152V32Z",opacity:"0.2"}),e.createElement("path",{d:"M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34ZM160,51.31,188.69,80H160ZM200,216H56V40h88V88a8,8,0,0,0,8,8h48V216Zm-42.34-77.66a8,8,0,0,1-11.32,11.32L136,139.31V184a8,8,0,0,1-16,0V139.31l-10.34,10.35a8,8,0,0,1-11.32-11.32l24-24a8,8,0,0,1,11.32,0Z"}))],["fill",e.createElement(e.Fragment,null,e.createElement("path",{d:"M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34Zm-56,67.32a8,8,0,0,1-11.32,0L136,139.31V184a8,8,0,0,1-16,0V139.31l-10.34,10.35a8,8,0,0,1-11.32-11.32l24-24a8,8,0,0,1,11.32,0l24,24A8,8,0,0,1,157.66,149.66ZM152,88V44l44,44Z"}))],["light",e.createElement(e.Fragment,null,e.createElement("path",{d:"M212.24,83.76l-56-56A6,6,0,0,0,152,26H56A14,14,0,0,0,42,40V216a14,14,0,0,0,14,14H200a14,14,0,0,0,14-14V88A6,6,0,0,0,212.24,83.76ZM158,46.48,193.52,82H158ZM200,218H56a2,2,0,0,1-2-2V40a2,2,0,0,1,2-2h90V88a6,6,0,0,0,6,6h50V216A2,2,0,0,1,200,218Zm-43.76-78.24a6,6,0,1,1-8.48,8.48L134,134.49V184a6,6,0,0,1-12,0V134.49l-13.76,13.75a6,6,0,0,1-8.48-8.48l24-24a6,6,0,0,1,8.48,0Z"}))],["regular",e.createElement(e.Fragment,null,e.createElement("path",{d:"M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34ZM160,51.31,188.69,80H160ZM200,216H56V40h88V88a8,8,0,0,0,8,8h48V216Zm-42.34-77.66a8,8,0,0,1-11.32,11.32L136,139.31V184a8,8,0,0,1-16,0V139.31l-10.34,10.35a8,8,0,0,1-11.32-11.32l24-24a8,8,0,0,1,11.32,0Z"}))],["thin",e.createElement(e.Fragment,null,e.createElement("path",{d:"M210.83,85.17l-56-56A4,4,0,0,0,152,28H56A12,12,0,0,0,44,40V216a12,12,0,0,0,12,12H200a12,12,0,0,0,12-12V88A4,4,0,0,0,210.83,85.17ZM156,41.65,198.34,84H156ZM200,220H56a4,4,0,0,1-4-4V40a4,4,0,0,1,4-4h92V88a4,4,0,0,0,4,4h52V216A4,4,0,0,1,200,220Zm-45.17-78.83a4,4,0,0,1-5.66,5.66L132,129.66V184a4,4,0,0,1-8,0V129.66l-17.17,17.17a4,4,0,0,1-5.66-5.66l24-24a4,4,0,0,1,5.66,0Z"}))]]),na=new Map([["bold",e.createElement(e.Fragment,null,e.createElement("path",{d:"M28,64A12,12,0,0,1,40,52H216a12,12,0,0,1,0,24H40A12,12,0,0,1,28,64Zm12,76h64a12,12,0,0,0,0-24H40a12,12,0,0,0,0,24Zm80,40H40a12,12,0,0,0,0,24h80a12,12,0,0,0,0-24Zm120.49,20.49a12,12,0,0,1-17,0l-18.08-18.08a44,44,0,1,1,17-17l18.08,18.07A12,12,0,0,1,240.49,200.49ZM184,164a20,20,0,1,0-20-20A20,20,0,0,0,184,164Z"}))],["duotone",e.createElement(e.Fragment,null,e.createElement("path",{d:"M216,144a32,32,0,1,1-32-32A32,32,0,0,1,216,144Z",opacity:"0.2"}),e.createElement("path",{d:"M32,64a8,8,0,0,1,8-8H216a8,8,0,0,1,0,16H40A8,8,0,0,1,32,64Zm8,72h72a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16Zm88,48H40a8,8,0,0,0,0,16h88a8,8,0,0,0,0-16Zm109.66,13.66a8,8,0,0,1-11.32,0L206,177.36A40,40,0,1,1,217.36,166l20.3,20.3A8,8,0,0,1,237.66,197.66ZM184,168a24,24,0,1,0-24-24A24,24,0,0,0,184,168Z"}))],["fill",e.createElement(e.Fragment,null,e.createElement("path",{d:"M32,64a8,8,0,0,1,8-8H216a8,8,0,0,1,0,16H40A8,8,0,0,1,32,64Zm8,72h72a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16Zm88,48H40a8,8,0,0,0,0,16h88a8,8,0,0,0,0-16Zm109.66,2.34L217.36,166A40,40,0,1,0,206,177.36l20.3,20.3a8,8,0,0,0,11.32-11.32Z"}))],["light",e.createElement(e.Fragment,null,e.createElement("path",{d:"M34,64a6,6,0,0,1,6-6H216a6,6,0,0,1,0,12H40A6,6,0,0,1,34,64Zm6,70h72a6,6,0,0,0,0-12H40a6,6,0,0,0,0,12Zm88,52H40a6,6,0,0,0,0,12h88a6,6,0,0,0,0-12Zm108.24,10.24a6,6,0,0,1-8.48,0l-21.49-21.48a38.06,38.06,0,1,1,8.49-8.49l21.48,21.49A6,6,0,0,1,236.24,196.24ZM184,170a26,26,0,1,0-26-26A26,26,0,0,0,184,170Z"}))],["regular",e.createElement(e.Fragment,null,e.createElement("path",{d:"M32,64a8,8,0,0,1,8-8H216a8,8,0,0,1,0,16H40A8,8,0,0,1,32,64Zm8,72h72a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16Zm88,48H40a8,8,0,0,0,0,16h88a8,8,0,0,0,0-16Zm109.66,13.66a8,8,0,0,1-11.32,0L206,177.36A40,40,0,1,1,217.36,166l20.3,20.3A8,8,0,0,1,237.66,197.66ZM184,168a24,24,0,1,0-24-24A24,24,0,0,0,184,168Z"}))],["thin",e.createElement(e.Fragment,null,e.createElement("path",{d:"M36,64a4,4,0,0,1,4-4H216a4,4,0,0,1,0,8H40A4,4,0,0,1,36,64Zm4,68h72a4,4,0,0,0,0-8H40a4,4,0,0,0,0,8Zm88,56H40a4,4,0,0,0,0,8h88a4,4,0,0,0,0-8Zm106.83,6.83a4,4,0,0,1-5.66,0l-22.72-22.72a36.06,36.06,0,1,1,5.66-5.66l22.72,22.72A4,4,0,0,1,234.83,194.83ZM184,172a28,28,0,1,0-28-28A28,28,0,0,0,184,172Z"}))]]),R=e.forwardRef((t,l)=>e.createElement(K,{ref:l,...t,weights:la}));R.displayName="FileArrowUpIcon";const ia=R,O=e.forwardRef((t,l)=>e.createElement(K,{ref:l,...t,weights:na}));O.displayName="ListMagnifyingGlassIcon";const ra=O,v="sip3s.pplUploads",A=()=>{if(typeof window>"u"||!("localStorage"in window))return[...w];const t=window.localStorage.getItem(v);if(!t)return window.localStorage.setItem(v,JSON.stringify(w)),[...w];try{const l=JSON.parse(t);return Array.isArray(l)?l:[...w]}catch(l){return console.warn("Gagal membaca cache upload PPL",l),[...w]}},I=t=>{if(!(typeof window>"u"||!("localStorage"in window)))try{window.localStorage.setItem(v,JSON.stringify(t))}catch(l){console.warn("Gagal menyimpan cache upload PPL",l)}},U=t=>[...t].sort((l,n)=>new Date(n.uploadedAt).getTime()-new Date(l.uploadedAt).getTime());class ca{async listAssignments(l){if(!l)return[];try{const{data:n}=await N.get("/ppl/assignments",{params:{email:l}});return n}catch{return sa.filter(m=>m.pplEmail===l)}}async listUploads(l,n){if(!l)return[];try{const{data:m}=await N.get("/ppl/uploads",{params:{email:l,type:n}});return m}catch{const r=A().filter(c=>c.uploader===l);return n?r.filter(c=>c.type===n):r}}async upload(l){const{file:n,type:m,assignment:r,uploader:c,notes:h}=l,o=new FormData;o.append("file",n),o.append("type",m),o.append("wilayahId",r.wilayahId),o.append("wilayahName",r.wilayahName),o.append("pplEmail",c),h&&o.append("notes",h);try{const{data:x}=await N.post("/ppl/uploads",o,{headers:{"Content-Type":"multipart/form-data"}}),u=A().filter(d=>d.id!==x.id);return I(U([x,...u])),x}catch{const y=await this.estimateRecords(n),u={id:$(),type:m,filename:n.name,wilayahId:r.wilayahId,wilayahName:r.wilayahName,uploader:c,totalRecords:y,sizeInKb:Math.round(n.size/1024),status:"tersimpan-offline",uploadedAt:new Date().toISOString(),message:"Data tersimpan lokal. Unggah ulang saat koneksi stabil."},g=A().filter(p=>p.id!==u.id);return I(U([u,...g])),u}}async estimateRecords(l){if(l.type.includes("csv")||l.name.toLowerCase().endsWith(".csv"))try{const r=(await l.text()).split(/\r?\n/).map(c=>c.trim()).filter(c=>c.length>0&&!c.startsWith("#"));return r.length<=1?0:r.length-1}catch(m){console.warn("Gagal menghitung jumlah baris CSV",m);return}}}const Z=new ca,B={simluhtan:{title:"Unggah Data Petani SIMLUHTAN",description:"Gunakan format CSV sesuai template agar data petani, kelompok, dan lahan dapat diproses otomatis.",template:"/templates/simluhtan-template.csv",accept:".csv,.xlsx,.xls",note:"Pastikan data sudah diverifikasi dengan dinas dan tidak ada baris kosong di tengah file."},erdkk:{title:"Unggah Data E-RDKK",description:"Import rencana kebutuhan pupuk bersubsidi per petani. Sistem akan memvalidasi NIK dan luas tanam.",template:"/templates/erdkk-template.csv",accept:".csv,.xlsx,.xls,.pdf",note:"Bila mengunggah PDF/Excel, Admin Spesialis akan membantu proses konversi ke format SIP3S."}},H={selesai:{badge:"success",label:"Selesai"},"tersimpan-offline":{badge:"warning",label:"Tersimpan Offline"},diproses:{badge:"neutral",label:"Sedang Diproses"},gagal:{badge:"warning",label:"Gagal"}},da=t=>new Date(t).toLocaleString("id-ID",{dateStyle:"medium",timeStyle:"short"}),ka=()=>{var V,E;const{user:t,logout:l}=q(),{isOnline:n}=Q(),m=z(),[r,c]=e.useState(null),[h,o]=e.useState(null),[x,y]=e.useState(null),u={simluhtan:e.useRef(null),erdkk:e.useRef(null)},d=S({queryKey:["ppl-assignments",t==null?void 0:t.email],queryFn:()=>Z.listAssignments(t==null?void 0:t.email),enabled:!!(t!=null&&t.email)}),g=S({queryKey:["ppl-uploads",t==null?void 0:t.email],queryFn:()=>Z.listUploads(t==null?void 0:t.email),enabled:!!(t!=null&&t.email)});e.useEffect(()=>{!r&&d.data&&d.data.length>0&&c(d.data[0].id)},[d.data,r]);const p=e.useMemo(()=>{var s;return((s=d.data)==null?void 0:s.find(i=>i.id===r))??void 0},[d.data,r]),M=J({mutationFn:async({file:s,category:i})=>{if(!(t!=null&&t.email))throw new Error("Sesi tidak valid. Silakan login ulang.");if(!p)throw new Error("Pilih wilayah kerja terlebih dahulu.");return Z.upload({file:s,type:i,assignment:p,uploader:t.email})},onMutate:({category:s})=>{y(s),o(null)},onSuccess:s=>{o({type:"success",message:`Berkas ${s.filename} siap diproses. Status: ${H[s.status].label}.`}),m.invalidateQueries({queryKey:["ppl-uploads",t==null?void 0:t.email]})},onError:s=>{const i=s instanceof Error?s.message:"Upload gagal. Coba ulangi.";o({type:"error",message:i})},onSettled:()=>{y(null)}}),T=s=>{var i;(i=u[s].current)==null||i.click()},G=async(s,i)=>{var j;const f=(j=i.target.files)==null?void 0:j[0];f&&(await M.mutateAsync({file:f,category:s}),i.target.value="")};return a.jsxs("main",{className:"mx-auto flex min-h-screen max-w-6xl flex-col gap-6 px-4 py-8",children:[h&&a.jsx(ta,{variant:h.type==="error"?"error":h.type==="success"?"success":"info",children:a.jsxs("div",{className:"flex items-center gap-2",children:[h.type==="success"?a.jsx(W,{className:"h-5 w-5",weight:"bold"}):h.type==="error"?a.jsx(ea,{className:"h-5 w-5",weight:"bold"}):a.jsx(ra,{className:"h-5 w-5",weight:"bold"}),a.jsx("span",{children:h.message})]})}),a.jsxs("header",{className:"rounded-3xl border border-hijau-hutan/30 bg-white p-6 shadow-sm",children:[a.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx("p",{className:"text-sm text-slate-netral",children:"Penyuluh Pertanian Lapangan"}),a.jsx("h1",{className:"text-2xl font-semibold text-hijau-hutan",children:(t==null?void 0:t.nama)??"PPL"}),a.jsx("p",{className:"text-xs text-slate-netral",children:"Unggah data resmi dari Dinas Pertanian untuk disinkronkan dengan Bhabinkamtibmas di wilayah tugas Anda."}),p&&a.jsxs("p",{className:"mt-2 flex items-center gap-2 text-xs text-slate-netral",children:[a.jsx(X,{className:"h-4 w-4 text-biru-pemerintah",weight:"bold"}),a.jsxs("span",{children:[p.wilayahName," � Kecamatan ",p.kecamatan]})]})]}),a.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[a.jsx(b,{variant:n?"success":"warning",children:n?"Online":"Offline"}),a.jsxs(k,{variant:"outline",onClick:l,children:[a.jsx(aa,{className:"mr-2 h-4 w-4",weight:"bold"})," Keluar"]})]})]}),a.jsxs("div",{className:"mt-4 flex flex-col gap-2 text-sm text-slate-netral",children:[a.jsxs("label",{className:"flex flex-col gap-1",children:["Wilayah kerja aktif",a.jsx("select",{value:r??"",onChange:s=>c(s.target.value),className:"w-full rounded-2xl border border-abu-kartu px-3 py-2 text-sm",children:(V=d.data)==null?void 0:V.map(s=>a.jsxs("option",{value:s.id,children:[s.wilayahName," � Kecamatan ",s.kecamatan]},s.id))})]}),d.isLoading&&a.jsx("span",{className:"text-xs text-slate-netral",children:"Memuat wilayah tugas..."}),((E=d.data)==null?void 0:E.length)===0&&!d.isLoading&&a.jsx("span",{className:"text-xs text-oranye-hangat",children:"Belum ada wilayah terdaftar. Hubungi Admin Spesialis untuk mendapatkan assignment."})]})]}),a.jsx("section",{className:"grid gap-4 lg:grid-cols-2",children:Object.keys(B).map(s=>{const i=B[s],f=M.isPending&&x===s;return a.jsxs(C,{className:"bg-white",children:[a.jsxs(L,{className:"space-y-3",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx(P,{children:i.title}),a.jsx(D,{children:i.description})]}),a.jsxs(b,{variant:"neutral",children:["CSV / Excel",s==="erdkk"?" / PDF":""]})]}),a.jsxs("div",{className:"flex flex-wrap gap-2",children:[a.jsxs(k,{type:"button",variant:"secondary",size:"sm",className:"gap-2",onClick:()=>window.open(i.template,"_blank"),children:[a.jsx(Y,{className:"h-4 w-4",weight:"bold"})," Unduh Template"]}),a.jsxs(k,{type:"button",className:"gap-2",onClick:()=>T(s),disabled:f||!p,children:[a.jsx(_,{className:"h-4 w-4",weight:"bold"}),f?"Mengunggah...":"Pilih Berkas"]})]}),a.jsx("input",{ref:u[s],type:"file",accept:i.accept,className:"hidden",onChange:j=>G(s,j)})]}),a.jsxs(F,{className:"space-y-3 text-sm text-slate-netral",children:[a.jsxs("div",{className:"rounded-2xl border border-dashed border-abu-kartu p-4 text-center",children:[a.jsx(ia,{className:"mx-auto mb-2 h-8 w-8 text-biru-pemerintah",weight:"bold"}),a.jsx("p",{className:"font-medium text-teks-gelap",children:p?`Unggah untuk ${p.wilayahName}`:"Pilih wilayah tugas terlebih dahulu"}),a.jsx("p",{className:"text-xs",children:i.note}),f&&a.jsx("p",{className:"mt-2 text-xs text-biru-pemerintah",children:"Memproses berkas..."})]}),a.jsxs("ul",{className:"list-disc space-y-1 pl-4 text-xs",children:[a.jsx("li",{children:"Gunakan nama file yang mencantumkan kecamatan, desa, dan periode (contoh: erdkk_nekamese_2025.csv)."}),a.jsx("li",{children:"Periksa kembali jumlah baris dan validitas NIK sebelum mengunggah."}),a.jsx("li",{children:"Sistem akan mengirim notifikasi ke Bhabinkamtibmas yang bertugas di wilayah yang sama."})]})]})]},s)})}),a.jsxs(C,{className:"bg-white",children:[a.jsxs(L,{className:"flex flex-wrap items-center justify-between gap-3",children:[a.jsxs("div",{children:[a.jsx(P,{children:"Riwayat Unggahan"}),a.jsx(D,{children:"Monitor status sinkronisasi data SIMLUHTAN dan E-RDKK."})]}),a.jsx(b,{variant:"neutral",children:"Terurut terbaru"})]}),a.jsx(F,{children:g.isLoading?a.jsx("p",{className:"text-sm text-slate-netral",children:"Memuat riwayat..."}):g.data&&g.data.length>0?a.jsx("div",{className:"overflow-x-auto",children:a.jsxs("table",{className:"min-w-full text-left text-sm text-slate-netral",children:[a.jsx("thead",{children:a.jsxs("tr",{className:"text-xs uppercase text-slate-netral/80",children:[a.jsx("th",{className:"py-2 pr-4",children:"Berkas"}),a.jsx("th",{className:"py-2 pr-4",children:"Wilayah"}),a.jsx("th",{className:"py-2 pr-4",children:"Jenis"}),a.jsx("th",{className:"py-2 pr-4",children:"Total Baris"}),a.jsx("th",{className:"py-2 pr-4",children:"Status"}),a.jsx("th",{className:"py-2",children:"Diunggah"})]})}),a.jsx("tbody",{children:g.data.map(s=>a.jsxs("tr",{className:"border-t border-abu-kartu/60",children:[a.jsx("td",{className:"py-3 pr-4 font-medium text-teks-gelap",children:s.filename}),a.jsxs("td",{className:"py-3 pr-4",children:[a.jsx("span",{className:"block text-xs uppercase text-slate-netral/70",children:s.wilayahId}),s.wilayahName]}),a.jsx("td",{className:"py-3 pr-4 capitalize",children:s.type}),a.jsx("td",{className:"py-3 pr-4",children:s.totalRecords??"-"}),a.jsx("td",{className:"py-3 pr-4",children:a.jsx(b,{variant:H[s.status].badge,children:H[s.status].label})}),a.jsx("td",{className:"py-3 text-xs",children:da(s.uploadedAt)})]},s.id))})]})}):a.jsx("p",{className:"text-sm text-slate-netral",children:"Belum ada berkas yang diunggah."})})]})]})};export{ka as default};
//# sourceMappingURL=index-B7mmgArx.js.map
