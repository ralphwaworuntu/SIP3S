import{n as A,r as i,j as e,B as h}from"./index-Cb9iWb3X.js";import{u as V,t as J,o as B,s as N,n as v,e as _,Z as g}from"./zod-PrevpNNo.js";import{u as q}from"./useQuery-C79pYyAu.js";import{u as z,m as G}from"./WarningCircle.es-D9kSxDjz.js";import{m as O}from"./ArrowsClockwise.es-B6UTnrte.js";import{u as W,a as Z,n as H,s as X}from"./use-camera-D0HlmIOR.js";import{s as Y}from"./CaretDown.es-Qlj1AIi3.js";import{s as ee}from"./CheckCircle.es-CuiNzjdL.js";import{p as se}from"./MapPinLine.es-CKveZeEs.js";import{h as ae}from"./ShieldCheck.es-nv1IhqZW.js";import{A as w}from"./alert-CMpuOtHs.js";import{B as te}from"./badge-BudpMpDX.js";import{C as I,a as M,b as D,c as L,d as Q}from"./card-D9DWCS54.js";import{b as U}from"./bhabin-service-1Ii3Tmwo.js";import"./mock-data-Bmemdn2s.js";const re=B({recipientId:N().min(1,"Pilih petani"),productType:_(["benih","pupuk"],{errorMap:()=>({message:"Pilih jenis produk"})}),seedType:N().optional(),seedQuantityKg:v({invalid_type_error:"Masukkan angka"}).min(0,"Minimal 0 Kg").optional(),pupukNpkKg:v({invalid_type_error:"Masukkan angka"}).min(0,"Minimal 0 Kg").optional(),pupukUreaKg:v({invalid_type_error:"Masukkan angka"}).min(0,"Minimal 0 Kg").optional(),notes:N().max(280,"Maksimal 280 karakter").optional()}).superRefine((t,d)=>{t.productType==="benih"&&(t.seedType||d.addIssue({code:g.custom,path:["seedType"],message:"Pilih jenis benih"}),(t.seedQuantityKg===void 0||Number.isNaN(t.seedQuantityKg))&&d.addIssue({code:g.custom,path:["seedQuantityKg"],message:"Isi jumlah benih (Kg)"})),t.productType==="pupuk"&&((t.pupukNpkKg===void 0||Number.isNaN(t.pupukNpkKg))&&d.addIssue({code:g.custom,path:["pupukNpkKg"],message:"Isi jumlah pupuk NPK"}),(t.pupukUreaKg===void 0||Number.isNaN(t.pupukUreaKg))&&d.addIssue({code:g.custom,path:["pupukUreaKg"],message:"Isi jumlah pupuk Urea"}))}),E={pending:{label:"Menunggu",variant:"warning"},verified:{label:"Terverifikasi",variant:"success"},rejected:{label:"Ditolak",variant:"warning"}},K=t=>t?new Date(t).toLocaleString("id-ID",{dateStyle:"medium",timeStyle:"short"}):"-",ie=t=>t?`${t.nama} • ${t.komoditas} • ${t.wilayah}`:"-- pilih petani --",Ne=()=>{const t=A(),[d,u]=i.useState(null),[k,T]=i.useState(""),[c,m]=i.useState(!1),f=i.useRef(null),S=i.useRef(null),r=W(),n=Z(),C=q({queryKey:["bhabin","recipients"],queryFn:()=>U.listRecipients()}),x=i.useMemo(()=>C.data??[],[C.data]),p=i.useMemo(()=>x.filter(s=>s.status==="pending"),[x]),P=i.useMemo(()=>{const s=k.trim().toLowerCase();return s?p.filter(o=>`${o.nama} ${o.nik} ${o.komoditas} ${o.wilayah}`.toLowerCase().includes(s)):p},[p,k]),a=V({resolver:J(re),defaultValues:{recipientId:"",productType:"benih",seedType:"",seedQuantityKg:void 0,pupukNpkKg:void 0,pupukUreaKg:void 0,notes:""}}),b=a.watch("recipientId"),y=a.watch("productType"),F=a.watch("seedType"),l=i.useMemo(()=>x.find(s=>s.id===b)??null,[b,x]),j=z({mutationFn:s=>U.verifyRecipient(s),onSuccess:()=>{t.invalidateQueries({queryKey:["bhabin","recipients"]}),u({type:"success",message:"Petani berhasil diverifikasi."}),a.reset({recipientId:"",productType:"benih",seedType:"",seedQuantityKg:void 0,pupukNpkKg:void 0,pupukUreaKg:void 0,notes:""}),n.restart(),m(!1)},onError:()=>u({type:"error",message:"Gagal memverifikasi. Coba ulangi."})});i.useEffect(()=>{if(!c){T("");return}const s=o=>{f.current&&!f.current.contains(o.target)&&m(!1)};return document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[c]),i.useEffect(()=>{if(c){const s=window.setTimeout(()=>{var o;return(o=S.current)==null?void 0:o.focus()},0);return()=>window.clearTimeout(s)}},[c]),i.useEffect(()=>{y==="benih"?(a.resetField("pupukNpkKg",{defaultValue:void 0}),a.resetField("pupukUreaKg",{defaultValue:void 0})):(a.resetField("seedType",{defaultValue:""}),a.resetField("seedQuantityKg",{defaultValue:void 0}))},[y,a]);const R=s=>{a.setValue("recipientId",s.id,{shouldValidate:!0,shouldDirty:!0}),a.clearErrors("recipientId"),m(!1)},$=s=>{if(!l){u({type:"error",message:"Pilih petani yang akan diverifikasi."}),m(!0);return}if(!r.latitude||!r.longitude){u({type:"error",message:"GPS belum siap. Tekan segarkan dan pastikan izin lokasi aktif."});return}if(!n.preview){u({type:"error",message:"Ambil foto dokumentasi penyaluran terlebih dahulu."});return}u(null),j.mutate({id:l.id,notes:s.notes,productType:s.productType,seedType:s.productType==="benih"?s.seedType:void 0,seedQuantityKg:s.productType==="benih"?s.seedQuantityKg:void 0,pupukNpkKg:s.productType==="pupuk"?s.pupukNpkKg:void 0,pupukUreaKg:s.productType==="pupuk"?s.pupukUreaKg:void 0,lokasi:{latitude:r.latitude,longitude:r.longitude,alamat:r.alamat},fotoEvidence:n.preview})};return e.jsxs("section",{className:"space-y-4",children:[d&&e.jsx(w,{variant:d.type==="success"?"success":d.type==="error"?"error":"info",children:e.jsxs("div",{className:"flex items-center gap-2",children:[d.type==="success"?e.jsx(ee,{className:"h-5 w-5",weight:"bold"}):e.jsx(G,{className:"h-5 w-5",weight:"bold"}),e.jsx("span",{children:d.message})]})}),e.jsxs(I,{className:"bg-white",children:[e.jsxs(M,{children:[e.jsx(D,{children:"Verifikasi penyaluran subsidi"}),e.jsx(L,{children:"Pilih petani, ambil lokasi dan dokumentasi untuk mengirim verifikasi resmi."})]}),e.jsx(Q,{className:"space-y-4 text-sm text-slate-netral",children:e.jsxs("form",{className:"space-y-4",onSubmit:a.handleSubmit($),children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("span",{children:"Pilih petani penerima"}),e.jsxs("div",{className:"relative",ref:f,children:[e.jsxs("button",{type:"button",className:"flex w-full items-center justify-between rounded-2xl border border-abu-kartu px-3 py-2 text-left text-sm text-teks-gelap hover:border-biru-pemerintah/60",onClick:()=>p.length>0&&m(s=>!s),disabled:p.length===0,children:[e.jsx("span",{className:l?"":"text-slate-netral",children:ie(l)}),e.jsx(Y,{className:"ml-2 h-4 w-4 text-slate-netral",weight:"bold"})]}),c&&e.jsxs("div",{className:"absolute z-30 mt-2 w-full rounded-2xl border border-abu-kartu bg-white p-3 shadow-xl",children:[e.jsx("input",{ref:S,type:"search",className:"w-full rounded-2xl border border-abu-kartu px-3 py-2 text-sm",placeholder:"Cari nama, NIK, komoditas, atau wilayah",value:k,onChange:s=>T(s.target.value)}),e.jsx("div",{className:"mt-2 max-h-60 overflow-y-auto",children:P.length>0?P.map(s=>{const o=s.id===b;return e.jsxs("button",{type:"button",className:`flex w-full flex-col items-start rounded-xl px-3 py-2 text-left text-sm transition hover:bg-biru-pemerintah/10 ${o?"bg-biru-pemerintah/10 text-biru-pemerintah":"text-teks-gelap"}`,onClick:()=>R(s),children:[e.jsx("span",{className:"font-medium",children:s.nama}),e.jsxs("span",{className:"text-xs text-slate-netral",children:[s.nik," • ",s.komoditas," • ",s.wilayah]})]},s.id)}):e.jsx("p",{className:"px-2 py-4 text-center text-sm text-slate-netral",children:"Tidak ditemukan data sesuai pencarian."})})]})]}),p.length===0&&e.jsx("span",{className:"text-xs text-slate-netral",children:"Tidak ada data menunggu verifikasi."}),a.formState.errors.recipientId&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:a.formState.errors.recipientId.message})]}),l&&e.jsxs("div",{className:"rounded-2xl border border-abu-kartu bg-white p-3 text-xs text-slate-netral",children:[e.jsx("p",{className:"text-sm font-semibold text-teks-gelap",children:l.nama}),e.jsxs("p",{children:["NIK: ",l.nik]}),e.jsxs("p",{children:["Kelompok: ",l.kelompok]}),e.jsxs("p",{children:["Komoditas: ",l.komoditas]}),e.jsxs("p",{children:["Wilayah: ",l.wilayah]}),e.jsxs("p",{children:["Jadwal distribusi: ",K(l.jadwalDistribusi)]})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:["Jenis produk subsidi",e.jsxs("select",{className:"rounded-2xl border border-abu-kartu px-3 py-2",...a.register("productType"),children:[e.jsx("option",{value:"benih",children:"Benih"}),e.jsx("option",{value:"pupuk",children:"Pupuk"})]}),a.formState.errors.productType&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:a.formState.errors.productType.message})]}),y==="benih"?e.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:["Pilih jenis benih",e.jsxs("select",{className:"rounded-2xl border border-abu-kartu px-3 py-2",...a.register("seedType"),defaultValue:"",children:[e.jsx("option",{value:"",children:"-- pilih jenis benih --"}),e.jsx("option",{value:"padi",children:"Padi"}),e.jsx("option",{value:"jagung",children:"Jagung"})]}),a.formState.errors.seedType&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:a.formState.errors.seedType.message})]}),F&&e.jsxs("label",{className:"flex flex-col gap-1",children:["Jumlah benih (Kg)",e.jsx("input",{type:"number",min:0,step:"0.1",className:"rounded-2xl border border-abu-kartu px-3 py-2",...a.register("seedQuantityKg",{valueAsNumber:!0})}),a.formState.errors.seedQuantityKg&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:a.formState.errors.seedQuantityKg.message})]})]}):e.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:["Jumlah pupuk NPK (Kg)",e.jsx("input",{type:"number",min:0,step:"0.1",className:"rounded-2xl border border-abu-kartu px-3 py-2",...a.register("pupukNpkKg",{valueAsNumber:!0})}),a.formState.errors.pupukNpkKg&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:a.formState.errors.pupukNpkKg.message})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:["Jumlah pupuk Urea (Kg)",e.jsx("input",{type:"number",min:0,step:"0.1",className:"rounded-2xl border border-abu-kartu px-3 py-2",...a.register("pupukUreaKg",{valueAsNumber:!0})}),a.formState.errors.pupukUreaKg&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:a.formState.errors.pupukUreaKg.message})]})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:["Catatan lapangan (opsional)",e.jsx("textarea",{className:"rounded-2xl border border-abu-kartu px-3 py-2",rows:3,placeholder:"Contoh: Produk subsidi diterima dengan baik",...a.register("notes")}),a.formState.errors.notes&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:a.formState.errors.notes.message})]}),e.jsxs("div",{className:"space-y-2 rounded-2xl border border-abu-kartu p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-medium text-teks-gelap",children:"Koordinat lokasi"}),e.jsxs(h,{type:"button",variant:"outline",size:"sm",onClick:r.refresh,disabled:r.isLoading,className:"inline-flex items-center gap-1",children:[e.jsx(O,{className:`h-4 w-4 ${r.isLoading?"animate-spin":""}`,weight:"bold"}),e.jsx("span",{children:r.isLoading?"Memuat":"Segarkan"})]})]}),e.jsxs("div",{className:"flex items-start gap-2 text-xs text-slate-netral",children:[e.jsx(se,{className:"mt-0.5 h-4 w-4",weight:"bold"}),e.jsxs("div",{children:[r.latitude&&r.longitude?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:r.alamat}),e.jsxs("p",{children:["Lat ",r.latitude.toFixed(4)," | Long ",r.longitude.toFixed(4)]})]}):r.isLoading?e.jsx("p",{children:"Mengambil lokasi terkini..."}):e.jsx("p",{children:"Lokasi belum tersedia. Pastikan izin GPS aktif lalu tekan segarkan."}),r.error&&e.jsx("p",{className:"text-oranye-hangat",children:r.error})]})]})]}),e.jsxs("div",{className:"space-y-3 rounded-2xl border border-abu-kartu p-3",children:[e.jsx("p",{className:"text-sm font-medium text-teks-gelap",children:"Dokumentasi penyaluran"}),n.streamError&&e.jsx(w,{variant:"warning",children:n.streamError}),n.preview?e.jsxs("div",{className:"space-y-3",children:[e.jsx("img",{src:n.preview,alt:"Dokumentasi penyaluran",className:"h-56 w-full rounded-2xl object-cover"}),e.jsxs(h,{type:"button",variant:"outline",onClick:n.restart,children:[e.jsx(X,{className:"mr-2 h-5 w-5",weight:"bold"})," Ambil Ulang"]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("video",{ref:n.videoRef,autoPlay:!0,playsInline:!0,className:"h-56 w-full rounded-2xl bg-black/60 object-cover"}),e.jsx("canvas",{ref:n.canvasRef,className:"hidden"}),e.jsxs(h,{type:"button",className:"w-full",onClick:n.capturePhoto,children:[e.jsx(H,{className:"mr-2 h-5 w-5",weight:"bold"})," Ambil Foto"]})]})]}),e.jsxs(h,{type:"submit",className:"w-full",disabled:j.isPending,children:[e.jsx(ae,{className:"mr-2 h-4 w-4",weight:"bold"}),j.isPending?"Memverifikasi...":"Kirim verifikasi"]}),e.jsx(w,{variant:"info",className:"text-xs",children:"Data disimpan otomatis meski offline dan akan tersinkron ketika koneksi kembali."})]})})]}),e.jsxs(I,{className:"bg-white",children:[e.jsxs(M,{children:[e.jsx(D,{children:"Riwayat verifikasi"}),e.jsx(L,{children:"Lihat catatan penerima yang sudah diverifikasi."})]}),e.jsx(Q,{className:"space-y-2 text-xs text-slate-netral",children:x.map(s=>e.jsxs("div",{className:"rounded-2xl border border-abu-kartu p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-teks-gelap",children:s.nama}),e.jsx(te,{variant:E[s.status].variant,children:E[s.status].label})]}),e.jsxs("p",{children:["Komoditas: ",s.komoditas]}),e.jsxs("p",{children:["Wilayah: ",s.wilayah]}),e.jsxs("p",{children:["Jadwal distribusi: ",K(s.jadwalDistribusi)]}),s.verifiedAt&&e.jsxs("p",{children:["Diverifikasi: ",K(s.verifiedAt)]}),s.notes&&e.jsxs("p",{children:["Catatan: ",s.notes]}),s.lokasi&&e.jsxs("p",{children:["Lokasi verifikasi: Lat ",s.lokasi.latitude.toFixed(4)," | Long ",s.lokasi.longitude.toFixed(4)]}),s.fotoEvidence&&e.jsx("img",{src:s.fotoEvidence,alt:`Dokumentasi ${s.nama}`,className:"mt-2 h-40 w-full rounded-2xl object-cover"})]},s.id))})]})]})};export{Ne as default};
//# sourceMappingURL=verify-recipients-CcicPi_w.js.map
