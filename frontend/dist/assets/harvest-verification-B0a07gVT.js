import{f as M,r as l,j as e,B as h}from"./index-CHgft2lY.js";import{u as A,t as V,o as q,s as g,c as P}from"./zod-Gn9GJoif.js";import{u as T}from"./useQuery-MNioBGo0.js";import{u as z}from"./useMutation-Clv9eckx.js";import{m as G}from"./ArrowsClockwise.es-HnGY3Lkl.js";import{u as Q,a as B,n as O,s as W}from"./use-camera-MX5YYxuW.js";import{s as J}from"./CaretDown.es-BcmPl2Vd.js";import{s as U}from"./CheckCircle.es-C5ggmx87.js";import{p as _}from"./MapPinLine.es-BnBamJ0U.js";import{m as X}from"./WarningCircle.es-CFc85ZaX.js";import{A as y}from"./alert-CxxZB5vu.js";import{C as L,a as D,b as H,c as I,d as E}from"./card-D1DJHsi0.js";import{b as N}from"./bhabin-service-CDJ-XKa-.js";import"./mock-data-CaIK6OKu.js";const Y=q({recipientId:g().min(1,"Pilih petani"),luasPanenHa:P.number().min(.1,"Minimal 0.1 Ha"),produksiTon:P.number().min(0,"Minimal 0"),lokasi:g().min(2,"Wajib diisi"),keterangan:g().optional()}),Z=o=>o?`${o.nama} • ${o.komoditas} • ${o.wilayah}`:"-- pilih petani --",R=o=>new Date(o).toLocaleString("id-ID",{dateStyle:"medium",timeStyle:"short"}),he=()=>{const o=M(),[m,d]=l.useState(null),[f,v]=l.useState(""),[u,p]=l.useState(!1),b=l.useRef(null),w=l.useRef(null),s=Q(),n=B(),S=T({queryKey:["bhabin","recipients"],queryFn:()=>N.listRecipients()}),x=l.useMemo(()=>S.data??[],[S.data]),c=l.useMemo(()=>x.filter(a=>a.status!=="rejected"),[x]),C=l.useMemo(()=>{const a=f.trim().toLowerCase();return a?c.filter(i=>`${i.nama} ${i.nik} ${i.komoditas} ${i.wilayah}`.toLowerCase().includes(a)):c},[c,f]),t=A({resolver:V(Y),defaultValues:{recipientId:"",luasPanenHa:1,produksiTon:0,lokasi:"",keterangan:""}}),k=t.watch("recipientId"),r=l.useMemo(()=>x.find(a=>a.id===k)??null,[k,x]);l.useEffect(()=>{if(!u){v("");return}const a=i=>{b.current&&!b.current.contains(i.target)&&p(!1)};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[u]),l.useEffect(()=>{if(u){const a=window.setTimeout(()=>{var i;return(i=w.current)==null?void 0:i.focus()},0);return()=>window.clearTimeout(a)}},[u]);const $=a=>{t.setValue("recipientId",a.id,{shouldValidate:!0,shouldDirty:!0}),t.clearErrors("recipientId"),p(!1)},K=T({queryKey:["bhabin","harvest"],queryFn:()=>N.listHarvestVerifications()}),j=z({mutationFn:a=>N.submitHarvestVerification(a),onSuccess:()=>{o.invalidateQueries({queryKey:["bhabin","harvest"]}),d({type:"success",message:"Verifikasi hasil panen tersimpan."}),t.reset({recipientId:"",luasPanenHa:1,produksiTon:0,lokasi:"",keterangan:""}),n.restart()},onError:()=>d({type:"error",message:"Gagal menyimpan verifikasi panen."})}),F=a=>{if(!r){d({type:"error",message:"Pilih petani terlebih dahulu."}),p(!0);return}if(!s.latitude||!s.longitude){d({type:"error",message:"GPS belum siap. Tekan segarkan dan pastikan izin lokasi aktif."});return}if(!n.preview){d({type:"error",message:"Ambil foto hasil panen terlebih dahulu."});return}d(null),j.mutate({...a,petani:r.nama,komoditas:r.komoditas,koordinat:{latitude:s.latitude,longitude:s.longitude,alamat:s.alamat},fotoEvidence:n.preview,verifier:"bhabin"})};return e.jsxs("section",{className:"grid gap-4 xl:grid-cols-[1fr_1fr]",children:[e.jsxs(L,{className:"bg-white",children:[e.jsxs(D,{children:[e.jsx(H,{children:"Verifikasi hasil panen"}),e.jsx(I,{children:"Catat hasil panen yang sudah diverifikasi di lapangan."})]}),e.jsxs(E,{className:"space-y-3 text-sm text-slate-netral",children:[m&&e.jsx(y,{variant:m.type==="success"?"success":m.type==="error"?"error":"info",children:e.jsxs("div",{className:"flex items-center gap-2",children:[m.type==="success"?e.jsx(U,{className:"h-5 w-5",weight:"bold"}):e.jsx(X,{className:"h-5 w-5",weight:"bold"}),e.jsx("span",{children:m.message})]})}),e.jsxs("form",{className:"space-y-3",onSubmit:t.handleSubmit(F),children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("span",{children:"Pilih petani penerima"}),e.jsxs("div",{className:"relative",ref:b,children:[e.jsxs("button",{type:"button",className:"flex w-full items-center justify-between rounded-2xl border border-abu-kartu px-3 py-2 text-left text-sm text-teks-gelap hover:border-biru-pemerintah/60",onClick:()=>c.length>0&&p(a=>!a),disabled:c.length===0,children:[e.jsx("span",{className:r?"":"text-slate-netral",children:Z(r)}),e.jsx(J,{className:"ml-2 h-4 w-4 text-slate-netral",weight:"bold"})]}),u&&e.jsxs("div",{className:"absolute z-30 mt-2 w-full rounded-2xl border border-abu-kartu bg-white p-3 shadow-xl",children:[e.jsx("input",{ref:w,type:"search",className:"w-full rounded-2xl border border-abu-kartu px-3 py-2 text-sm",placeholder:"Cari nama, NIK, komoditas, atau wilayah",value:f,onChange:a=>v(a.target.value)}),e.jsx("div",{className:"mt-2 max-h-60 overflow-y-auto",children:C.length>0?C.map(a=>{const i=a.id===k;return e.jsxs("button",{type:"button",className:`flex w-full flex-col items-start rounded-xl px-3 py-2 text-left text-sm transition hover:bg-biru-pemerintah/10 ${i?"bg-biru-pemerintah/10 text-biru-pemerintah":"text-teks-gelap"}`,onClick:()=>$(a),children:[e.jsx("span",{className:"font-medium",children:a.nama}),e.jsxs("span",{className:"text-xs text-slate-netral",children:[a.nik," • ",a.komoditas," • ",a.wilayah]})]},a.id)}):e.jsx("p",{className:"px-2 py-4 text-center text-sm text-slate-netral",children:"Tidak ditemukan data sesuai pencarian."})})]})]}),c.length===0&&e.jsx("span",{className:"text-xs text-slate-netral",children:"Belum ada data penerima."}),t.formState.errors.recipientId&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:t.formState.errors.recipientId.message})]}),r&&e.jsxs("div",{className:"rounded-2xl border border-abu-kartu bg-white p-3 text-xs text-slate-netral",children:[e.jsx("p",{className:"text-sm font-semibold text-teks-gelap",children:r.nama}),e.jsxs("p",{children:["NIK: ",r.nik]}),e.jsxs("p",{children:["Kelompok: ",r.kelompok]}),e.jsxs("p",{children:["Komoditas: ",r.komoditas]}),e.jsxs("p",{children:["Wilayah: ",r.wilayah]}),e.jsxs("p",{children:["Jadwal distribusi: ",R(r.jadwalDistribusi)]})]}),e.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:["Luas panen (Ha)",e.jsx("input",{type:"number",step:"0.01",min:.1,className:"rounded-2xl border border-abu-kartu px-3 py-2",...t.register("luasPanenHa",{valueAsNumber:!0})}),t.formState.errors.luasPanenHa&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:t.formState.errors.luasPanenHa.message})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:["Produksi (Ton)",e.jsx("input",{type:"number",step:"0.01",min:0,className:"rounded-2xl border border-abu-kartu px-3 py-2",...t.register("produksiTon",{valueAsNumber:!0})}),t.formState.errors.produksiTon&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:t.formState.errors.produksiTon.message})]})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:["Lokasi penyimpanan hasil panen",e.jsx("input",{className:"rounded-2xl border border-abu-kartu px-3 py-2",...t.register("lokasi")}),t.formState.errors.lokasi&&e.jsx("span",{className:"text-xs text-oranye-hangat",children:t.formState.errors.lokasi.message})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:["Keterangan tambahan",e.jsx("textarea",{className:"rounded-2xl border border-abu-kartu px-3 py-2",rows:3,...t.register("keterangan")})]}),e.jsxs("div",{className:"space-y-2 rounded-2xl border border-abu-kartu p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-medium text-teks-gelap",children:"Koordinat lokasi"}),e.jsxs(h,{type:"button",variant:"outline",size:"sm",onClick:s.refresh,disabled:s.isLoading,className:"inline-flex items-center gap-1",children:[e.jsx(G,{className:`h-4 w-4 ${s.isLoading?"animate-spin":""}`,weight:"bold"}),e.jsx("span",{children:s.isLoading?"Memuat":"Segarkan"})]})]}),e.jsxs("div",{className:"flex items-start gap-2 text-xs text-slate-netral",children:[e.jsx(_,{className:"mt-0.5 h-4 w-4",weight:"bold"}),e.jsxs("div",{children:[s.latitude&&s.longitude?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:s.alamat}),e.jsxs("p",{children:["Lat ",s.latitude.toFixed(4)," | Long ",s.longitude.toFixed(4)]})]}):s.isLoading?e.jsx("p",{children:"Mengambil lokasi terkini..."}):e.jsx("p",{children:"Lokasi belum tersedia. Pastikan izin GPS aktif lalu tekan segarkan."}),s.error&&e.jsx("p",{className:"text-oranye-hangat",children:s.error})]})]})]}),e.jsxs("div",{className:"space-y-3 rounded-2xl border border-abu-kartu p-3",children:[e.jsx("p",{className:"text-sm font-medium text-teks-gelap",children:"Dokumentasi hasil panen"}),n.streamError&&e.jsx(y,{variant:"warning",children:n.streamError}),n.preview?e.jsxs("div",{className:"space-y-3",children:[e.jsx("img",{src:n.preview,alt:"Dokumentasi panen",className:"h-56 w-full rounded-2xl object-cover"}),e.jsxs(h,{type:"button",variant:"outline",onClick:n.restart,children:[e.jsx(W,{className:"mr-2 h-5 w-5",weight:"bold"})," Ambil Ulang"]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("video",{ref:n.videoRef,autoPlay:!0,playsInline:!0,className:"h-56 w-full rounded-2xl bg-black/60 object-cover"}),e.jsx("canvas",{ref:n.canvasRef,className:"hidden"}),e.jsxs(h,{type:"button",className:"w-full",onClick:n.capturePhoto,children:[e.jsx(O,{className:"mr-2 h-5 w-5",weight:"bold"})," Ambil Foto"]})]})]}),e.jsx(h,{type:"submit",className:"w-full",disabled:j.isPending,children:j.isPending?"Menyimpan...":"Simpan verifikasi"}),e.jsx(y,{variant:"info",className:"text-xs",children:"Data disimpan otomatis meski offline dan akan tersinkron ketika koneksi kembali."})]})]})]}),e.jsxs(L,{className:"bg-white",children:[e.jsxs(D,{children:[e.jsx(H,{children:"Riwayat verifikasi panen"}),e.jsx(I,{children:"Daftar panen yang telah Anda cek."})]}),e.jsx(E,{className:"space-y-2 text-xs text-slate-netral",children:(K.data??[]).map(a=>e.jsxs("div",{className:"rounded-2xl border border-abu-kartu p-3",children:[e.jsx("p",{className:"text-sm font-medium text-teks-gelap",children:a.petani}),e.jsxs("p",{children:["Komoditas: ",a.komoditas]}),e.jsxs("p",{children:["Luas panen: ",a.luasPanenHa," Ha"]}),e.jsxs("p",{children:["Produksi: ",a.produksiTon," Ton"]}),e.jsxs("p",{children:["Lokasi penyimpanan: ",a.lokasi]}),e.jsxs("p",{children:["Diverifikasi: ",R(a.diverifikasiAt)]}),a.koordinat&&e.jsxs("p",{children:["Koordinat: Lat ",a.koordinat.latitude.toFixed(4)," | Long ",a.koordinat.longitude.toFixed(4)]}),a.keterangan&&e.jsxs("p",{children:["Keterangan: ",a.keterangan]}),a.fotoEvidence&&e.jsx("img",{src:a.fotoEvidence,alt:`Dokumentasi panen ${a.petani}`,className:"mt-2 h-32 w-full rounded-2xl object-cover"})]},a.id))})]})]})};export{he as default};
//# sourceMappingURL=harvest-verification-B0a07gVT.js.map
